<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œìŠ¤íŠ¸ì•„í¬ í†µí•© ê³„ì‚°ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif; /* Using Inter font */
        }

        body {
            background: url('https://i.imgur.com/GAlbv0G.jpg') center/cover no-repeat fixed;
            min-height: 100vh;
            display: flex;
            color: #374151; /* Default text color */
        }

        /* Sidebar styles */
        .sidebar {
            width: 280px;
            /* Changed transparency from 0.95 to 0.65 for more background visibility */
            background: rgba(30, 41, 59, 0.65);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            border-top-right-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .logo {
            width: 100%;
            /* Increased height by three times (from 80px to 240px) */
            height: 240px;
            background: url('https://i.imgur.com/5sjUCyF.jpg') center/contain no-repeat;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .menu {
            flex: 1;
        }

        .menu-item {
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .menu-item:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.6);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: linear-gradient(45deg, #3b82f6, #1e40af);
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }

        /* Main content styles */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .calculator-section {
            display: none;
        }

        .calculator-section.active {
            display: block;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto; /* Center the grid */
        }

        .calculator-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .calculator-card h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 700;
            text-align: center;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease, background 0.3s ease;
            background: #f9fafb;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
        }

        /* Button groups */
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 6px;
        }

        .option-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .option-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        .option-btn:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .calculate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .calculate-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Result display */
        .result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(248, 250, 252, 0.9);
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .result.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result h4 {
            color: #1e293b;
            margin-bottom: 12px;
            font-size: 1em;
            font-weight: 600;
        }

        .result-item {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            font-size: 13px;
        }

        /* Specific result item styles */
        .rank-fighter {
            background: #f0fdf4;
            border-left-color: #22c55e;
            color: #15803d;
        }
        .rank-crucial {
            background: #fffbeb;
            border-left-color: #f59e0b;
            color: #d97706;
        }
        .rank-bloody {
            background: #fef2f2;
            border-left-color: #ef4444;
            color: #dc2626;
        }

        .cutoff-info {
            background: #eff6ff;
            border-left-color: #3b82f6;
            color: #1e40af;
        }

        .auto-input {
            background: #f0fdf4 !important;
            border-color: #22c55e !important;
        }

        /* Dealer selection for 'ë²„ëŸ¬ì§€ ë”œëŸ¬ ê³„ì‚°ê¸°' */
        .dealer-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .dealer-label {
            min-width: 60px;
            font-weight: 600;
            color: #374151;
            font-size: 12px;
        }

        .dealer-buttons {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .dealer-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: white;
            color: #374151;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dealer-btn.fighter { border-color: #22c55e; color: #15803d; }
        .dealer-btn.fighter.active { background: #22c55e; color: white; }
        .dealer-btn.crucial { border-color: #f59e0b; color: #d97706; }
        .dealer-btn.crucial.active { background: #f59e0b; color: white; }
        .dealer-btn.bloody { border-color: #ef4444; color: #dc2626; }
        .dealer-btn.bloody.active { background: #ef4444; color: white; }
        .dealer-btn.unknown { border-color: #6b7280; color: #4b5563; }
        .dealer-btn.unknown.active { background: #6b7280; color: white; }

        /* Congratulations message */
        .congratulations {
            background: linear-gradient(135deg, #ec4899, #f97316);
            color: white;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            animation: celebration 1s ease-in-out;
        }

        @keyframes celebration {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .profit { color: #059669; font-weight: 600; }
        .loss { color: #dc2626; font-weight: 600; }

        /* Auction recommendation cards */
        .auction-recommendation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .recommendation-card {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid;
            transition: transform 0.2s ease;
        }

        .recommendation-card:hover {
            transform: translateY(-2px);
        }

        .recommendation-card.profit-card {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-color: #22c55e;
            color: #15803d;
        }

        .recommendation-card.breakeven-card {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border-color: #f59e0b;
            color: #d97706;
        }

        .recommendation-card .card-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .recommendation-card .card-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .recommendation-card .card-amount {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .recommendation-card .card-desc {
            font-size: 11px;
            opacity: 0.8;
        }

        .single-calculator {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Custom Alert/Message Box */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .message-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .message-box-overlay.show .message-box {
            transform: translateY(0);
        }

        .message-box h4 {
            font-size: 1.2em;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .message-box p {
            font-size: 0.95em;
            color: #475569;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .message-box button {
            background: linear-gradient(45deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .message-box button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }


        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .calculator-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
                border-radius: 0; /* Remove border-radius on small screens */
            }
            
            .logo {
                height: 120px; /* Adjusted for mobile responsiveness, still larger */
                margin-bottom: 20px;
            }
            
            .menu {
                display: flex;
                overflow-x: auto; /* Allow horizontal scrolling for menu items */
                gap: 10px;
                padding-bottom: 10px; /* Add padding for scrollbar */
            }
            
            .menu-item {
                min-width: 150px;
                margin-bottom: 0;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .auction-recommendation {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"></div>
        <nav class="menu">
            <button class="menu-item active" data-section="raid">
                ğŸ´â€â˜ ï¸ ë ˆì´ë“œ ê³„ì‚°ê¸°
            </button>
            <button class="menu-item" data-section="auction">
                ï¿½ ê²½ë§¤ ì…ì°°ê¸ˆ ê³„ì‚°ê¸°
            </button>
        </nav>
    </div>

    <div class="main-content">
        <!-- Raid Calculator Section -->
        <div class="calculator-section active" id="raid-section">
            <div class="calculator-grid">
                <!-- Damage Calculator -->
                <div class="calculator-card">
                    <h3>ì”í˜ˆ ê³„ì‚°ê¸°</h3>
                    
                    <div class="form-group">
                        <label>ë ˆì´ë“œ ì„ íƒ</label>
                        <div class="button-group" id="raid-buttons">
                            <button class="option-btn" data-value="ì—ê¸°ë¥´">ì—ê¸°ë¥´</button>
                            <button class="option-btn" data-value="ì•„ë¸Œë ìŠˆë“œ">ì•„ë¸Œë ìŠˆë“œ</button>
                            <button class="option-btn" data-value="ëª¨ë¥´ë‘ ">ëª¨ë¥´ë‘ </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ë‚œì´ë„</label>
                        <div class="button-group" id="difficulty-buttons">
                            <button class="option-btn" data-value="ë…¸ë§" disabled>ë…¸ë§</button>
                            <button class="option-btn" data-value="í•˜ë“œ" disabled>í•˜ë“œ</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ê´€ë¬¸</label>
                        <div class="button-group" id="gate-buttons">
                            <button class="option-btn" data-value="1ê´€" disabled>1ê´€</button>
                            <button class="option-btn" data-value="2ê´€" disabled>2ê´€</button>
                            <button class="option-btn" data-value="3ê´€" disabled>3ê´€</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="damage-input">ë‚´ ë”œëŸ‰ (ì–µ ë‹¨ìœ„)</label>
                        <input type="number" id="damage-input" placeholder="ì˜ˆ: 350.5" step="0.1" min="0">
                    </div>

                    <button class="calculate-btn" id="raid-calculate" disabled>ê²°ê³¼ ê³„ì‚°</button>

                    <div class="result" id="raid-result">
                        <h4>ê³„ì‚° ê²°ê³¼</h4>
                        <div id="raid-result-content"></div>
                    </div>

                    <div class="result" id="cutoff-display">
                        <h4>ì»· ì •ë³´</h4>
                        <div id="cutoff-content"></div>
                    </div>
                </div>

                <!-- Burden Dealer Calculator -->
                <div class="calculator-card">
                    <h3>ë²„ëŸ¬ì§€ ë”œëŸ¬ ê³„ì‚°ê¸°</h3>
                    
                    <div class="form-group">
                        <label>íŒŒí‹° êµ¬ì„±</label>
                        <div class="button-group" id="party-type-buttons">
                            <button class="option-btn" data-value="4">4ì¸</button>
                            <button class="option-btn" data-value="8">8ì¸</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="my-damage-percent">ë‚´ ë”œ í¼ì„¼íŠ¸ (%)</label>
                        <input type="number" id="my-damage-percent" placeholder="ìë™ ì…ë ¥ë©ë‹ˆë‹¤" step="0.1" min="0" readonly class="auto-input">
                    </div>

                    <div class="form-group" id="dealer-selection" style="display: none;">
                        <label>íŒŒí‹°ì›ë“¤ì˜ ë”œ ë“±ê¸‰</label>
                        <div id="dealer-rows"></div>
                    </div>

                    <button class="calculate-btn" id="party-calculate" disabled>ë²„ëŸ¬ì§€ ë”œëŸ¬ ì°¾ê¸°</button>

                    <div class="result" id="party-result">
                        <h4>íŒŒí‹° ë¶„ì„ ê²°ê³¼</h4>
                        <div id="party-result-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auction Calculator Section -->
        <div class="calculator-section" id="auction-section">
            <div class="single-calculator">
                <div class="calculator-card">
                    <h3>ê²½ë§¤ ì…ì°°ê¸ˆ ê³„ì‚°ê¸°</h3>
                    
                    <div class="form-group">
                        <label for="auction-price">ê²½ë§¤ì¥ íŒë§¤ ê¸ˆì•¡ (ê³¨ë“œ)</label>
                        <input type="number" id="auction-price" placeholder="ì˜ˆ: 30000" min="0">
                    </div>

                    <div class="form-group">
                        <label>ì°¸ì—¬ ì¸ì›ìˆ˜</label>
                        <div class="button-group" id="participants-buttons">
                            <button class="option-btn" data-value="4">4ì¸</button>
                            <button class="option-btn" data-value="8">8ì¸</button>
                            <button class="option-btn" data-value="16">16ì¸</button>
                        </div>
                    </div>

                    <div class="result" id="auction-result">
                        <h4>ì…ì°° ì¶”ì²œ ì •ë³´</h4>
                        <div id="auction-result-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box HTML -->
    <div class="message-box-overlay" id="message-box-overlay">
        <div class="message-box">
            <h4 id="message-box-title"></h4>
            <p id="message-box-content"></p>
            <button id="message-box-ok">í™•ì¸</button>
        </div>
    </div>

    <script>
        console.log('ğŸš€ ë¡œìŠ¤íŠ¸ì•„í¬ í†µí•© ê³„ì‚°ê¸° ë¡œë“œë¨!');
        
        // Boss data for Raid Calculator
        const bossData = {
            "ì—ê¸°ë¥´": {
                "ë…¸ë§": {
                    "1ê´€": { hp: 1615, fighterCut: 270, crucialCut: { min: 270, max: 365 }, bloodyCut: 365 },
                    "2ê´€": { hp: 2132, fighterCut: 335, crucialCut: { min: 335, max: 450 }, bloodyCut: 450 }
                },
                "í•˜ë“œ": {
                    "1ê´€": { hp: 2698, fighterCut: 450, crucialCut: { min: 450, max: 600 }, bloodyCut: 600 },
                    "2ê´€": { hp: 3985, fighterCut: 600, crucialCut: { min: 600, max: 800 }, bloodyCut: 800 }
                }
            },
            "ì•„ë¸Œë ìŠˆë“œ": {
                "ë…¸ë§": {
                    "1ê´€": { hp: 2754, fighterCut: 450, crucialCut: { min: 450, max: 600 }, bloodyCut: 600 },
                    "2ê´€": { hp: 3994, fighterCut: 610, crucialCut: { min: 610, max: 810 }, bloodyCut: 810 }
                },
                "í•˜ë“œ": {
                    "1ê´€": { hp: 5163, fighterCut: 900, crucialCut: { min: 900, max: 1200 }, bloodyCut: 1200 },
                    "2ê´€": { hp: 8253, fighterCut: 1200, crucialCut: { min: 1200, max: 1600 }, bloodyCut: 1600 }
                }
            },
            "ëª¨ë¥´ë‘ ": {
                "ë…¸ë§": {
                    "1ê´€": { hp: 3687, fighterCut: 525, crucialCut: { min: 525, max: 700 }, bloodyCut: 700 },
                    "2ê´€": { hp: 3346, fighterCut: 460, crucialCut: { min: 460, max: 620 }, bloodyCut: 620 },
                    "3ê´€": { hp: 7319, fighterCut: 1000, crucialCut: { min: 1000, max: 1360 }, bloodyCut: 1360 }
                },
                "í•˜ë“œ": {
                    "1ê´€": { hp: 6525, fighterCut: 940, crucialCut: { min: 940, max: 1250 }, bloodyCut: 1250 },
                    "2ê´€": { hp: 6630, fighterCut: 970, crucialCut: { min: 970, max: 1300 }, bloodyCut: 1300 },
                    "3ê´€": { hp: 14737, fighterCut: 2150, crucialCut: { min: 2150, max: 2950 }, bloodyCut: 2950 }
                }
            }
        };

        // Global state variables for calculators
        let selectedRaid = '';
        let selectedDifficulty = '';
        let selectedGate = '';
        let selectedParticipants = 0; // For Auction Calculator
        let selectedPartyType = 0; // For Burden Dealer Calculator (4 or 8 players)
        let myDamagePercent = 0; // For Burden Dealer Calculator
        let dealerRanks = []; // Array to store ranks of other dealers

        // --- Utility Functions ---

        /**
         * Displays a custom message box instead of alert().
         * @param {string} title - The title of the message box.
         * @param {string} message - The content message.
         */
        function showMessageBox(title, message) {
            const overlay = document.getElementById('message-box-overlay');
            document.getElementById('message-box-title').textContent = title;
            document.getElementById('message-box-content').textContent = message;
            overlay.classList.add('show');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            document.getElementById('message-box-overlay').classList.remove('show');
        }

        /**
         * Handles clicks on option buttons within a specific group.
         * @param {HTMLElement} container - The container element for the buttons.
         * @param {string} dataAttribute - The data attribute to read (e.g., 'value').
         * @param {function} callback - Callback function to execute with the selected value.
         */
        function setupOptionButtons(containerId, dataAttribute, callback) {
            const container = document.getElementById(containerId);
            if (!container) return; // Exit if container doesn't exist

            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('option-btn') && !e.target.disabled) {
                    // Remove 'active' from all buttons in this group
                    container.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('active'));
                    // Add 'active' to the clicked button
                    e.target.classList.add('active');
                    // Execute callback with the selected value
                    callback(e.target.dataset[dataAttribute]);
                }
            });
        }

        /**
         * Updates the disabled state of a calculate button based on conditions.
         * @param {string} buttonId - The ID of the calculate button.
         * @param {boolean} condition - The condition that enables the button.
         */
        function updateCalculateButtonState(buttonId, condition) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = !condition;
            }
        }

        /**
         * Resets the active state of buttons within a group and disables them if specified.
         * @param {string} containerId - The ID of the button group container.
         * @param {boolean} disable - Whether to disable the buttons after resetting.
         */
        function resetOptionButtons(containerId, disable = false) {
            const container = document.getElementById(containerId);
            if (container) {
                container.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.disabled = disable;
                });
            }
        }

        // --- Menu Navigation ---
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all menu items and sections
                document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
                document.querySelectorAll('.calculator-section').forEach(cs => cs.classList.remove('active'));
                
                // Add active class to clicked item and corresponding section
                this.classList.add('active');
                const sectionId = this.dataset.section + '-section';
                document.getElementById(sectionId).classList.add('active');
            });
        });

        // --- Raid Calculator Logic ---

        /**
         * Updates the state and UI for raid selection.
         * @param {string} raid - The selected raid name.
         */
        function handleRaidSelection(raid) {
            selectedRaid = raid;
            resetOptionButtons('difficulty-buttons', false); // Enable difficulty buttons
            resetOptionButtons('gate-buttons', true); // Disable gate buttons initially
            selectedDifficulty = ''; // Reset difficulty
            selectedGate = ''; // Reset gate
            document.getElementById('cutoff-display').classList.remove('show'); // Hide cutoff info
            updateRaidCalculateButton();
        }

        /**
         * Updates the state and UI for difficulty selection.
         * @param {string} difficulty - The selected difficulty.
         */
        function handleDifficultySelection(difficulty) {
            selectedDifficulty = difficulty;
            resetOptionButtons('gate-buttons', true); // Disable all gate buttons first
            selectedGate = ''; // Reset gate
            document.getElementById('cutoff-display').classList.remove('show'); // Hide cutoff info

            // Enable only relevant gate buttons based on selected raid and difficulty
            if (selectedRaid && selectedDifficulty && bossData[selectedRaid][selectedDifficulty]) {
                Object.keys(bossData[selectedRaid][selectedDifficulty]).forEach(gate => {
                    const gateBtn = document.querySelector(`#gate-buttons .option-btn[data-value="${gate}"]`);
                    if (gateBtn) gateBtn.disabled = false;
                });
            }
            updateRaidCalculateButton();
        }

        /**
         * Updates the state and UI for gate selection and displays cutoff info.
         * @param {string} gate - The selected gate.
         */
        function handleGateSelection(gate) {
            selectedGate = gate;
            const bossInfo = bossData[selectedRaid][selectedDifficulty][selectedGate];
            if (bossInfo) {
                document.getElementById('cutoff-content').innerHTML = `
                    <div class="result-item cutoff-info">
                        <strong>${selectedRaid} ${selectedDifficulty} ${selectedGate}</strong>
                    </div>
                    <div class="result-item cutoff-info">
                        íˆ¬ì‚¬: ${bossInfo.fighterCut}ì–µ ë¯¸ë§Œ
                    </div>
                    <div class="result-item cutoff-info">
                        ê°•íˆ¬: ${bossInfo.crucialCut.min}~${bossInfo.crucialCut.max}ì–µ
                    </div>
                    <div class="result-item cutoff-info">
                        ì”í˜ˆ: ${bossInfo.bloodyCut}ì–µ ì´ìƒ
                    </div>
                `;
                document.getElementById('cutoff-display').classList.add('show');
            }
            updateRaidCalculateButton();
        }

        /**
         * Updates the enabled/disabled state of the raid calculate button.
         */
        function updateRaidCalculateButton() {
            const damageInput = document.getElementById('damage-input');
            const isValid = selectedRaid && selectedDifficulty && selectedGate && damageInput.value !== '';
            updateCalculateButtonState('raid-calculate', isValid);
        }

        /**
         * Performs the raid damage calculation and displays results.
         */
        function calculateRaidDamage() {
            const damageInput = document.getElementById('damage-input');
            const damage = parseFloat(damageInput.value);

            if (!selectedRaid || !selectedDifficulty || !selectedGate || isNaN(damage) || damage < 0) {
                showMessageBox('ì…ë ¥ ì˜¤ë¥˜', 'ëª¨ë“  í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš” (ë”œëŸ‰ì€ 0 ì´ìƒ).');
                return;
            }

            const bossInfo = bossData[selectedRaid][selectedDifficulty][selectedGate];
            const damagePercentage = (damage / bossInfo.hp) * 100;

            let rank, rankClass;
            if (damage < bossInfo.fighterCut) {
                rank = 'íˆ¬ì‚¬';
                rankClass = 'rank-fighter';
            } else if (damage < bossInfo.bloodyCut) {
                rank = 'ê°•íˆ¬';
                rankClass = 'rank-crucial';
            } else {
                rank = 'ì”í˜ˆ';
                rankClass = 'rank-bloody';
            }

            document.getElementById('raid-result-content').innerHTML = `
                <div class="result-item ${rankClass}">
                    <strong>ë”œëŸ‰:</strong> ${damage.toLocaleString()}ì–µ
                </div>
                <div class="result-item ${rankClass}">
                    <strong>ë“±ê¸‰:</strong> ${rank} (${damagePercentage.toFixed(1)}%)
                </div>
            `;
            document.getElementById('raid-result').classList.add('show');

            // Automatically update my-damage-percent for Burden Dealer Calculator
            myDamagePercent = damagePercentage;
            const myPercentInput = document.getElementById('my-damage-percent');
            if (myPercentInput) {
                myPercentInput.value = damagePercentage.toFixed(1);
            }
            updatePartyCalculateButton();
        }

        // Event listeners for Raid Calculator
        setupOptionButtons('raid-buttons', 'value', handleRaidSelection);
        setupOptionButtons('difficulty-buttons', 'value', handleDifficultySelection);
        setupOptionButtons('gate-buttons', 'value', handleGateSelection);
        document.getElementById('damage-input')?.addEventListener('input', updateRaidCalculateButton);
        document.getElementById('raid-calculate')?.addEventListener('click', calculateRaidDamage);


        // --- Burden Dealer Calculator Logic ---

        /**
         * Handles party type selection (4 or 8 players).
         * @param {string} type - '4' or '8'.
         */
        function handlePartyTypeSelection(type) {
            selectedPartyType = parseInt(type);
            const dealerCount = selectedPartyType === 4 ? 2 : 5; // 4-man party has 3 dealers (1 me + 2 others), 8-man has 6 dealers (1 me + 5 others)
            dealerRanks = new Array(dealerCount).fill(''); // Reset dealer ranks

            let dealerHTML = '';
            for (let i = 0; i < dealerCount; i++) {
                dealerHTML += `
                    <div class="dealer-row">
                        <div class="dealer-label">ë”œëŸ¬${i + 1}</div>
                        <div class="dealer-buttons" data-dealer-row="${i}">
                            <button class="dealer-btn fighter" data-dealer="${i}" data-rank="íˆ¬ì‚¬">íˆ¬ì‚¬</button>
                            <button class="dealer-btn crucial" data-dealer="${i}" data-rank="ê°•íˆ¬">ê°•íˆ¬</button>
                            <button class="dealer-btn bloody" data-dealer="${i}" data-rank="ì”í˜ˆ">ì”í˜ˆ</button>
                            <button class="dealer-btn unknown" data-dealer="${i}" data-rank="ëª¨ë¦„">ëª¨ë¦„</button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('dealer-rows').innerHTML = dealerHTML;
            document.getElementById('dealer-selection').style.display = 'block';
            document.getElementById('party-result').classList.remove('show'); // Hide previous result

            // Add event listener for the newly created dealer buttons using delegation
            document.getElementById('dealer-rows').addEventListener('click', handleDealerRankSelection);
            updatePartyCalculateButton();
        }

        /**
         * Handles selection of individual dealer ranks.
         * @param {Event} e - The click event.
         */
        function handleDealerRankSelection(e) {
            if (e.target.classList.contains('dealer-btn')) {
                const dealerIndex = parseInt(e.target.dataset.dealer);
                const rank = e.target.dataset.rank;
                
                // Remove 'active' from all buttons in this dealer's row
                document.querySelectorAll(`[data-dealer="${dealerIndex}"]`).forEach(btn => btn.classList.remove('active'));
                // Add 'active' to the clicked button
                e.target.classList.add('active');
                dealerRanks[dealerIndex] = rank;
                
                updatePartyCalculateButton();
            }
        }

        /**
         * Updates the enabled/disabled state of the party calculate button.
         */
        function updatePartyCalculateButton() {
            const allDealerRanksSelected = dealerRanks.every(rank => rank !== '');
            const hasMyPercent = myDamagePercent > 0;
            updateCalculateButtonState('party-calculate', allDealerRanksSelected && hasMyPercent);
        }

        /**
         * Calculates and displays burden dealer information.
         */
        function findBurdenDealers() {
            console.log('ğŸ¯ ë²„ëŸ¬ì§€ ë”œëŸ¬ ì°¾ê¸° ì‹œì‘!');
            
            if (selectedPartyType === 0 || myDamagePercent === 0 || dealerRanks.some(rank => rank === '')) {
                showMessageBox('ì…ë ¥ ì˜¤ë¥˜', 'íŒŒí‹° êµ¬ì„±, ë‚´ ë”œ í¼ì„¼íŠ¸, ê·¸ë¦¬ê³  ëª¨ë“  íŒŒí‹°ì›ì˜ ë”œ ë“±ê¸‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // Total number of actual dealers in the party (excluding supports)
            // 4-man party: 3 dealers (1 support)
            // 8-man party: 6 dealers (2 supports)
            const totalDealersCount = selectedPartyType === 4 ? 3 : 6;
            const supportCount = selectedPartyType === 4 ? 1 : 2;
            const totalDealerTarget = 100 - (supportCount * 2); // Assuming supports contribute 2% each to total party damage

            const fighterCount = dealerRanks.filter(r => r === 'íˆ¬ì‚¬').length;
            const crucialCount = dealerRanks.filter(r => r === 'ê°•íˆ¬').length;
            const bloodyCount = dealerRanks.filter(r => r === 'ì”í˜ˆ').length;
            const unknownCount = dealerRanks.filter(r => r === 'ëª¨ë¦„').length;

            const myDamage = myDamagePercent;
            // Approximate damage contribution based on rank
            // íˆ¬ì‚¬ (Fighter): ~10%
            // ê°•íˆ¬ (Crucial): ~15%
            // ì”í˜ˆ (Bloody): ~20%
            const fighterDamageEstimate = fighterCount * 10;
            const crucialDamageEstimate = crucialCount * 15;
            const bloodyDamageEstimate = bloodyCount * 20;
            
            const confirmedDamage = myDamage + fighterDamageEstimate + crucialDamageEstimate + bloodyDamageEstimate;
            const remainingDamage = totalDealerTarget - confirmedDamage;
            const unknownAverageDamage = unknownCount > 0 ? remainingDamage / unknownCount : 0;

            console.log('ê³„ì‚° ê²°ê³¼:', {
                totalDealerTarget,
                confirmedDamage,
                remainingDamage,
                unknownCount,
                unknownAverageDamage,
                isFighter: unknownAverageDamage < 15 // If average of unknown is less than 15%, they are likely fighters
            });

            let html = '';

            html += `
                <div class="result-item" style="background: #fff3cd; border-left-color: #ffc107; color: #856404;">
                    <strong>ğŸ“Š ìƒì„¸ ê³„ì‚°:</strong><br>
                    â€¢ ë”œëŸ¬ ëª©í‘œ: ${totalDealerTarget}% (${selectedPartyType}ì¸ íŒŒí‹° ì¤‘ ë”œëŸ¬ ${totalDealersCount}ëª…)<br>
                    â€¢ ë‚´ ë”œ: ${myDamage.toFixed(1)}%<br>
                    â€¢ í™•ì¸ëœ ë”œëŸ¬ë“¤ì˜ ì˜ˆìƒ í•©ì‚° ë”œ: ${confirmedDamage.toFixed(1)}%<br>
                    â€¢ ë¯¸í™•ì¸ ë”œëŸ¬ë“¤ì—ê²Œ ìš”êµ¬ë˜ëŠ” ë”œ: ${remainingDamage.toFixed(1)}%<br>
                    â€¢ ëª¨ë¦„ ${unknownCount}ëª… í‰ê·  ë”œ: ${unknownAverageDamage.toFixed(1)}%<br>
                    â€¢ <strong>${unknownAverageDamage.toFixed(1)}% ${unknownAverageDamage < 15 ? '< 15% â†’ ğŸš¨ íˆ¬ì‚¬ ì¶”ì •!' : 'â‰¥ 15% â†’ ê°•íˆ¬ ì´ìƒ ì¶”ì •'}</strong>
                </div>
            `;

            const hasFighters = fighterCount > 0;
            const hasHiddenFighters = unknownCount > 0 && unknownAverageDamage < 15;

            if (hasFighters || hasHiddenFighters) {
                html += `
                    <div class="congratulations">
                        ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ë²„ëŸ¬ì§€ ë”œëŸ¬ì˜ í†µë‚˜ë¬´ë¥¼ ë“¤ì–´ì£¼ì…¨êµ°ìš”! ğŸ‰
                    </div>
                `;

                if (hasFighters) {
                    html += `<div class="result-item rank-fighter"><strong>í™•ì • íˆ¬ì‚¬:</strong> ${fighterCount}ëª…</div>`;
                }

                if (hasHiddenFighters) {
                    html += `
                        <div class="result-item rank-bloody">
                            <strong>ğŸš¨ ìˆ¨ê²¨ì§„ íˆ¬ì‚¬ ì¶”ì •:</strong> ${unknownCount}ëª…<br>
                            <small>í‰ê·  ${unknownAverageDamage.toFixed(1)}% (15% ë¯¸ë§Œ)</small>
                        </div>
                    `;
                }

                html += `<div class="result-item"><strong>ì´ íˆ¬ì‚¬ (ì¶”ì •) ìˆ˜:</strong> ${fighterCount + (hasHiddenFighters ? unknownCount : 0)}ëª…</div>`;
            } else {
                html += `
                    <div class="result-item rank-fighter">
                        <strong>âœ… ë‹¤í–‰íˆ íˆ¬ì‚¬ ë”œëŸ¬ëŠ” ì—†ìŠµë‹ˆë‹¤!</strong><br>
                        <small>ëª¨ë¦„ ë”œëŸ¬ í‰ê· : ${unknownAverageDamage.toFixed(1)}% (ê°•íˆ¬ ì´ìƒ)</small>
                    </div>
                `;
            }

            document.getElementById('party-result-content').innerHTML = html;
            document.getElementById('party-result').classList.add('show');
        }

        // Event listeners for Burden Dealer Calculator
        setupOptionButtons('party-type-buttons', 'value', handlePartyTypeSelection);
        document.getElementById('party-calculate')?.addEventListener('click', findBurdenDealers);


        // --- Auction Calculator Logic ---

        /**
         * Calculates and displays auction bid recommendations.
         */
        function calculateAuction() {
            const salePriceInput = document.getElementById('auction-price');
            const salePrice = parseFloat(salePriceInput?.value || 0);

            if (isNaN(salePrice) || selectedParticipants === 0 || salePrice <= 0) {
                document.getElementById('auction-result').classList.remove('show');
                return;
            }

            const actualSalePrice = Math.round(salePrice * 0.95); // 5% auction fee
            const breakEvenBid = Math.round(actualSalePrice * 0.75); // 75% of net sale price for 1/4 split
            const recommendedBid = Math.round(breakEvenBid * 0.91); // ~91% of breakeven for profit (e.g., 67% of original)

            document.getElementById('auction-result-content').innerHTML = `
                <div class="result-item">
                    <strong>ğŸ“Š ê¸°ë³¸ ì •ë³´</strong>
                </div>
                <div class="result-item">
                    <strong>íŒë§¤ ê¸ˆì•¡:</strong> ${salePrice.toLocaleString()} ê³¨ë“œ
                </div>
                <div class="result-item">
                    <strong>ìˆ˜ë ¹ ê¸ˆì•¡:</strong> ${actualSalePrice.toLocaleString()} ê³¨ë“œ (5% ìˆ˜ìˆ˜ë£Œ ì œì™¸)
                </div>
                <div class="result-item">
                    <strong>ì°¸ì—¬ ì¸ì›:</strong> ${selectedParticipants}ì¸
                </div>
                
                <div class="auction-recommendation">
                    <div class="recommendation-card profit-card">
                        <span class="card-icon">ğŸ¯</span>
                        <div class="card-title">ì…ì°° ì¶”ì²œê°€</div>
                        <div class="card-amount">${recommendedBid.toLocaleString()}</div>
                        <div class="card-desc">ì´ë“ì„ ë³¼ ìˆ˜ ìˆëŠ” ê¸ˆì•¡</div>
                    </div>
                    
                    <div class="recommendation-card breakeven-card">
                        <span class="card-icon">âš–ï¸</span>
                        <div class="card-title">ì†ìµ ë¶„ê¸°ì </div>
                        <div class="card-amount">${breakEvenBid.toLocaleString()}</div>
                        <div class="card-desc">ì†í•´ë¥¼ ë³´ì§€ ì•ŠëŠ” í•œê³„ì„ </div>
                    </div>
                </div>
                
                <div class="result-item" style="background: #f0f9ff; border-left-color: #0ea5e9; color: #0c4a6e;">
                    <strong>ğŸ’¡ ì…ì°° ê°€ì´ë“œ</strong><br>
                    â€¢ <strong style="color: #15803d;">${recommendedBid.toLocaleString()}ê³¨ë“œ ì´í•˜</strong>: ì´ë“ ë³´ì¥<br>
                    â€¢ <strong style="color: #d97706;">${recommendedBid.toLocaleString()} ~ ${breakEvenBid.toLocaleString()}ê³¨ë“œ</strong>: ì†Œí­ ì´ë“<br>
                    â€¢ <strong style="color: #dc2626;">${breakEvenBid.toLocaleString()}ê³¨ë“œ ì´ˆê³¼</strong>: ì†í•´ ë°œìƒ
                </div>
            `;

            document.getElementById('auction-result').classList.add('show');
        }

        // Event listeners for Auction Calculator
        setupOptionButtons('participants-buttons', 'value', (value) => {
            selectedParticipants = parseInt(value);
            calculateAuction();
        });
        document.getElementById('auction-price')?.addEventListener('input', calculateAuction);

        // Initialize message box close button
        document.getElementById('message-box-ok')?.addEventListener('click', hideMessageBox);

        console.log('âœ… ëª¨ë“  ê¸°ëŠ¥ ë¡œë“œ ì™„ë£Œ!');
    </script>
</body>
</html>
ï¿½